<!doctype html>
<!-- The Time Machine GitHub pages theme was designed and developed by Jon Rohan, on Feb 7, 2012. -->
<!-- Follow him for fun. http://twitter.com/jonrohan. Tail his code on https://github.com/jonrohan -->
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <link rel="stylesheet" href="stylesheets/stylesheet.css" media="screen">
  <link rel="stylesheet" href="stylesheets/github-dark.css">
  <link rel="stylesheet" href="stylesheets/enhance/classes.css">
  <link rel="stylesheet" href="stylesheets/enhance/zoom.css">
  <link rel="stylesheet" href="stylesheets/shCore.css">
  <link rel="stylesheet" href="stylesheets/shThemeRDark.css">
  <script type="text/javascript" src="javascripts/script.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="http://cdn.jsdelivr.net/velocity/1.2.2/velocity.min.js"></script>
  <script type="text/javascript" src="javascripts/enhance.js"></script>
  <script type="text/javascript" src="javascripts/shCore.js"></script>
  <script type="text/javascript" src="javascripts/shBrushXml.js"></script>
  <title>Blog</title>
  <meta name="description" content="">

  <meta name="viewport" content="width=device-width,initial-scale=1">

</head>

<body>

  <div class="wrapper">
    <header>
      <h1 class="title">Blog</h1>
    </header>
    <div id="container">
      <p class="tagline"></p>
      <div id="main" role="main">
        <div class="download-bar">
          <span class="inner title">Because technics matters</span>
          <div class="inner">
            <!-- <a href="https://github.com/imatmati/blog/tarball/master" class="download-button tar"><span>Download</span></a>
            <a href="https://github.com/imatmati/blog/zipball/master" class="download-button zip"><span>Download</span></a>-->
            <a href="https://github.com/imatmati/blog" class="code">View Blog on GitHub</a>
          </div>
          <span class="blc"></span><span class="trc"></span>
        </div>
        <article class="markdown-body">

          <h3>















<a id="saml-passport" class="anchor" href="#saml-passport" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SAML Authentication with WSO2 / LDAP / PASSPORT / EXPRESS</h3>

          <p>
            Authentication with standard protocols is often a daunting task for most people. SAML, OAuth2, etc. seem cumbersome and too difficult to integrate in an application. What's more, their roles and limits are fuzzy to a lot of developpers. Let's try to demystify
            this natural functionnality in any web application. In this tutorial, we'll use SAML2 with WSO2 Identity Server connected to a LDAP server as a users store. The application will be implemented with Express / Passport.
          </p>
          <p>
            <h4>Prerequisites</h4>
            <ul>
              <li><a href="http://apache.mirrors.ovh.net/ftp.apache.org/dist/directory/studio/2.0.0.v20151221-M10/ApacheDirectoryStudio-2.0.0.v20151221-M10-win32.win32.x86_64.zip">Apache studio directory</a></li>
              <li><a href="https://nodejs.org/dist/v4.4.3/node-v4.4.3-x64.msi">Node</a> </li>
              <li><a href="http://product-dist.wso2.com/products/identity-server/5.1.0/wso2is-5.1.0.zip">WSO2</a></li>
              <li><a href="https://github.com/c9/core">C9</a></li>
            </ul>
          </p>
          <p>
            So, Apache Directory Studio will be our LDAP server, but of course you should be able to use any other LDAP Server in your own environment. WSO2 is well documented and easy to manage, it will take the role of our Identity Server. And C9 is my little sweet
            IDE for any Javascript development, I recommend it but you can use any other one convenient to you. Do I need to present Node ?
          </p>
          <section>
            <p>
              <h4>Configuration</h4> After installation of all requirements, let's begin to configure our environment.
              <h5>LDAP Server creation</h5> Launch Apache Studio and then create a LDAP Server. In the "LDAP Servers" tab, click on "New Server" button.
              <div class="interlign"></div>
              <img src="images/saml-passport/ldap-creation.png" />
            </p>
            <p>
              Then, check the ports of your newly created LDAP Server by double clicking the new server.
              <div class="interlign"></div>
              <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-ports.png" />
            </p>
            <p>
              Now, proceed to create a connection to your LDAP Server as shown below
              <div class="interlign"></div>
              <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-connection.png" />
            </p>
            <p>
              You should get a confirmation message
              <div class="interlign"></div>
              <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-connection-created.png" />
            </p>
            <p>
              Open it by double-clicking it in the "connection" tab or by contextual menu
              <div class="interlign"></div>
              <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-connection-open.png" />
            </p>
            <section>
              <p>
                <h5>User & Group creation</h5> Users and roles can be created directly in WSO2, but for demonstration sake let's create them in the LDAP. If you want to automatize users and roles creation or import, you'll need this section. First, create a user in the LDAP under
                ou=users,ou=system.
                <div class="interlign"></div>
                <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-user-creation-1.png" /> Follow the assistant as described
                <div class="interlign"></div>
                <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-user-creation-2.png" />
                <p>Give it a inetOrgPerson class, automatically a few others classes will be added
                  <div class="interlign"></div>
                  <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-user-creation-3.png" />
                </p>
                <p>Then choose a name as its uid. Here, very cleverly I choose "me" as the best name describing ... me.
                  <div class="interlign"></div>
                  <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-user-creation-4.png" />
                </p>
                <p>A sn and cn are needed to confom to the LDAP Schema. Add them in the assistant before trying to create it
                  <div class="interlign"></div>
                  <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-user-creation-5.png" />
                </p>
                <p>No authentication without password, add it as a new attribute by these two steps by right-click then "New Attribute"
                  <div class="interlign"></div>
                  <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-user-creation-6.png" />
                </p>
                <p>Then
                  <div class="interlign"></div>
                  <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-user-creation-7.png" />
                </p>
              </p>
              <p>Choose a good and secured password. And more securely, choose a salted algo like SSHA
                <div class="interlign"></div>
                <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-user-creation-8.png" />
              </p>
              </p>
            </section>
            <section>
              <p>Now, create a group for our user as follows. First, create a new entry under ou=groups,ou=system with "groupOfNames" class. Let's call it "basic"
                <div class="interlign"></div>
                <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-group-creation-1.png" />
                <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-group-creation-2.png" />
              </p>
              </p>
              <p>Then add "me" user as a member after clicking next
                <div class="interlign"></div>
                <img data-action="zoom" class="cropped" src="images/saml-passport/ldap-group-creation-3.png" />
              </p>
              <section>
                <section>
                  <h5>WSO2 configuration</h5>
                  <p>WSO2 runs an embedded LDAP Server we must disable and replace by our own one.To that purpose, under %WSO2_HOME/repository/conf/identity/embedded-ldap.xml, turn it off</p>
                  <div class="excerpt"><pre class="brush: xml">
                    <EmbeddedLDAP>
                      <Property name="enable">false</Property>
                      ...
                    </EmbeddedLDAP>
                  </pre></div>

                  <p>Now, let's indicates how to connect to our LDAP Server, change the following section from  %WSO2_HOME/repository/conf/user-mgt.xml according your environment.</p>
                  <div class="excerpt"><pre class="brush: xml">
                     <UserStoreManager class="org.wso2.carbon.user.core.ldap.ReadWriteLDAPUserStoreManager">
                      <Property name="TenantManager">org.wso2.carbon.user.core.tenant.CommonHybridLDAPTenantManager</Property>
                      <Property name="ConnectionURL">ldap://localhost:${Ports.EmbeddedLDAP.LDAPServerPort}</Property>
                      <Property name="ConnectionPassword">admin</Property>
                      <Property name="UserSearchBase">ou=Users,dc=wso2,dc=org</Property>
                      <Property name="UserEntryObjectClass">identityPerson</Property>
                      <Property name="UserNameAttribute">uid</Property>
                      <Property name="UserNameSearchFilter">(&amp;(objectClass=person)(uid=?))</Property>
                      <Property name="UserNameListFilter">(objectClass=person)</Property>
                  			.....
                			<Property name="GroupSearchBase">ou=Groups,dc=wso2,dc=org</Property>
                  			.....
                			<Property name="SCIMEnabled">true</Property>
                    		.....
                			<Property name="defaultRealmName">WSO2.ORG</Property>
                  			...
                    </UserStoreManager>
                  </pre></div>
                  <p>In our case, we'll change them to </p>
                  <div class="excerpt"><pre class="brush: xml">
                    <Property name="ConnectionURL">ldap://localhost:${Ports.EmbeddedLDAP.LDAPServerPort}</Property>
                    <Property name="ConnectionPassword">secret</Property>
                    <Property name="UserSearchBase">ou=users,ou=system</Property>
                    <Property name="UserEntryObjectClass">inetOrgPerson</Property>
              			...
              			<Property name="GroupSearchBase">ou=groups,ou=system</Property>
              			...
              			<Property name="SCIMEnabled">false</Property>
              			...
              			<Property name="defaultRealmName">mycompany.org</Property>
                  </pre></div>
                  <p>This section needs some explanations.<br/>
                    <ul>
                      <li>
                    I didn't change the port configuration as the expression in ConnectionURL property resolves to 10389 (have a look at %WSO2_HOME/repository/conf/carbon.xml to Server/Ports/EmbeddedLDAP/LDAPServerPort element to get the value).
                    You remember we checked the port value of our LDAP Server and it was indeed 10389. So no need to change it. Of course, in our example we'll address a local server but in your production environment you'll have to name it instead of localhost.
                      </li><li>
                    The default password of the admin user of ApacheDirectoryStudio is secret so change it in ConnectionPassword property.
                     </li><li>
                    The base of our user entries is ou=users,ou=system in our LDAP Server so be the value of UserSearchBase property.
                     </li><li>
                    Our class of users was inetOrgPerson not identityPerson.Accord UserEntryObjectClass to this value.
                     </li><li>
                    The group entries base is located elsewhere than the default configuration. Switch GroupSearchBase to ou=groups,ou=system for the same reason as the users entries.
                     </li><li>
                    Turn SCIM off, we don't need it here.
                     </li><li>
                    Of course name your realm according your topology, here I chose mycompany.org as defaultRealmName.
                     </li>
                    </ul>
                  </p>
                  <p>Launch the WSO2 IS server by %WSO2_HOME/bin/wso2server.bat start. Don't forget to set JAVA_HOME before that.</p>
                </section>
                <section>
                  <!--             
          <h3>
          


<a id="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Welcome to GitHub Pages.</h3>

          <p>This automatic page generator is the easiest way to create beautiful pages for all of your projects. Author your page content here <a href="https://guides.github.com/features/mastering-markdown/">using GitHub Flavored Markdown</a>, select a
            template crafted by a designer, and publish. After your page is generated, you can check out the new <code>gh-pages</code> branch locally. If you’re using GitHub Desktop, simply sync your repository and you’ll see the new branch.</p>

          <h3>











<a id="designer-templates" class="anchor" href="#designer-templates" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Designer Templates</h3>

          <p>We’ve crafted some handsome templates for you to use. Go ahead and click 'Continue to layouts' to browse through them. You can easily go back to edit your page before publishing. After publishing your page, you can revisit the page generator
            and switch to another theme. Your Page content will be preserved.</p>

          <h3>







<a id="creating-pages-manually" class="anchor" href="#creating-pages-manually" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Creating pages manually</h3>

          <p>If you prefer to not use the automatic generator, push a branch named <code>gh-pages</code> to your repository to create a page manually. In addition to supporting regular HTML content, GitHub Pages support Jekyll, a simple, blog aware static
            site generator. Jekyll makes it easy to create site-wide headers and footers without having to copy them across every page. It also offers intelligent blog support and other advanced templating features.</p>

          <h3>











<a id="authors-and-contributors" class="anchor" href="#authors-and-contributors" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authors and Contributors</h3>

          <p>You can <a href="https://help.github.com/articles/basic-writing-and-formatting-syntax/#mentioning-users-and-teams" class="user-mention">@mention</a> a GitHub username to generate a link to their profile. The resulting <code>&lt;a&gt;</code>            element will link to the contributor’s GitHub Profile. For example: In 2007, Chris Wanstrath (<a href="https://github.com/defunkt" class="user-mention">@defunkt</a>), PJ Hyett (<a href="https://github.com/pjhyett" class="user-mention">@pjhyett</a>),
            and Tom Preston-Werner (<a href="https://github.com/mojombo" class="user-mention">@mojombo</a>) founded GitHub.</p>

          <h3>











<a id="support-or-contact" class="anchor" href="#support-or-contact" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support or Contact</h3>

          <p>Having trouble with Pages? Check out our <a href="https://help.github.com/pages">documentation</a> or <a href="https://github.com/contact">contact support</a> and we’ll help you sort it out.</p>
              -->
        </article>
      </div>
    </div>

    <footer>
      <div class="owner">
        <p>
          <a href="https://github.com/imatmati" class="avatar"><img src="https://avatars3.githubusercontent.com/u/10572439?v=3&amp;s=60" width="48" height="48"></a> <a href="https://github.com/imatmati">imatmati</a> maintains <a href="https://github.com/imatmati/blog">Blog</a></p>


      </div>
      <div class="creds">
        <small>This page generated using <a href="https://pages.github.com/">GitHub Pages</a><br>theme by <a href="https://twitter.com/jonrohan/">Jon Rohan</a></small>
      </div>
    </footer>
  </div>
  <div class="current-section">
    <a href="#top">Scroll to top</a>
    <a href="https://github.com/imatmati/blog/tarball/master" class="tar">tar</a><a href="https://github.com/imatmati/blog/zipball/master" class="zip">zip</a><a href="" class="code">source code</a>
    <p class="name"></p>
  </div>


</body>

</html>
